{% extends 'core/base.html' %}

{% block title %}Dashboard Gestor{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Painel do Gestor</h2>
    <div>
        <a href="{% url 'cadastrar_relator' %}" class="btn btn-outline-primary me-2">
            <i class="bi bi-person-plus"></i> Novo Relator
        </a>
        <a href="{% url 'cadastrar_projeto' %}" class="btn btn-primary">
            <i class="bi bi-plus-lg"></i> Cadastrar Novo Projeto
        </a>
    </div>
</div>

<ul class="nav nav-tabs mb-4" id="gestorTab" role="tablist">
    <li class="nav-item">
        <button class="nav-link active" id="projetos-tab" data-bs-toggle="tab" data-bs-target="#projetos" type="button">
            <i class="bi bi-folder2-open"></i> Gestão de Projetos
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" id="relatores-tab" data-bs-toggle="tab" data-bs-target="#relatores" type="button">
            <i class="bi bi-people"></i> Gestão de Relatores
        </button>
    </li>
</ul>

<div class="tab-content" id="gestorTabContent">
    
    <div class="tab-pane fade show active" id="projetos" role="tabpanel">
        
        <div class="card mb-4 bg-light">
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-3">
                        <select id="filterField" class="form-select">
                            <option value="all" selected>Buscar em Todos</option>
                            <option value="titulo">Nome do Projeto</option>
                            <option value="caae">CAAE</option>
                            <option value="pesquisador">Pesquisador</option>
                            <option value="relator-nome">Nome do Relator</option>
                            <option value="relator-email">E-mail do Relator</option>
                        </select>
                    </div>
                    <div class="col-md-9">
                        <input type="text" id="searchInput" class="form-control" placeholder="Digite para filtrar...">
                    </div>
                </div>
            </div>
        </div>

        <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-aguardando">Aguardando <span class="badge bg-secondary ms-1">{{ itens_novos|length }}</span></button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-analise">Em Análise <span class="badge bg-secondary ms-1">{{ itens_em_analise|length }}</span></button></li>
            
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-pendentes">Pendentes <span class="badge bg-danger ms-1">{{ itens_pendentes|length }}</span></button></li>
            
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-concluidos">Concluídos <span class="badge bg-secondary ms-1">{{ itens_concluidos|length }}</span></button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="pills-aguardando">
                {% include "core/includes/tabela_projetos.html" with lista_itens=itens_novos titulo="Aguardando Designação" cor="warning" tipo="aguardando" msg_vazia="Nenhum item aguardando." %}
            </div>
            <div class="tab-pane fade" id="pills-analise">
                {% include "core/includes/tabela_projetos.html" with lista_itens=itens_em_analise titulo="Em Análise" cor="info" tipo="analise" msg_vazia="Nenhum item em análise." %}
            </div>
            
            <div class="tab-pane fade" id="pills-pendentes">
                {% include "core/includes/tabela_projetos.html" with lista_itens=itens_pendentes titulo="Pendentes (Com Pesquisador)" cor="danger" tipo="pendente" msg_vazia="Nenhum projeto pendente." %}
            </div>

            <div class="tab-pane fade" id="pills-concluidos">
                {% include "core/includes/tabela_projetos.html" with lista_itens=itens_concluidos titulo="Concluídos" cor="success" tipo="concluido" msg_vazia="Nenhum item concluído." %}
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="relatores" role="tabpanel">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <strong>Visão Geral dos Relatores</strong>
                <a href="{% url 'exportar_relatores' %}" class="btn btn-light btn-sm text-primary">
                    <i class="bi bi-file-earmark-spreadsheet"></i> Exportar Excel
                </a>
            </div>
            <div class="card-body">
                <input type="text" id="searchRelatorInput" class="form-control mb-3" placeholder="Filtrar relator...">
                
                <div class="accordion" id="accordionRelatores">
                    {% for relator in relatores_stats %}
                    <div class="accordion-item relator-item">
                        <h2 class="accordion-header" id="heading{{ relator.id }}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ relator.id }}">
                                <span class="fw-bold relator-name">{{ relator.first_name|default:relator.username }}</span>
                                <span class="badge bg-secondary ms-2">{{ relator.projetos_designados.count }} Projetos</span>
                                <span class="ms-2 text-muted small relator-email">({{ relator.email }})</span>
                            </button>
                        </h2>
                        <div id="collapse{{ relator.id }}" class="accordion-collapse collapse" data-bs-parent="#accordionRelatores">
                            <div class="accordion-body">
                                {% if relator.projetos_designados.all %}
                                    <ul class="list-group">
                                    {% for projeto in relator.projetos_designados.all %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>
                                                <strong>{{ projeto.titulo }}</strong> 
                                                <small class="text-muted ms-2">({{ projeto.get_status_display }})</small>
                                            </span>
                                            <a href="{% url 'detalhe_projeto' projeto.id %}" class="btn btn-sm btn-outline-primary">Ver</a>
                                        </li>
                                    {% endfor %}
                                    </ul>
                                {% else %}
                                    <p class="text-muted mb-0">Este relator não possui projetos designados no momento.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% empty %}
                        <p class="text-muted text-center mb-0">Nenhum relator cadastrado no sistema.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function filterProjects() {
        let filterValue = document.getElementById("searchInput").value.toLowerCase();
        let filterField = document.getElementById("filterField").value;
        let tables = document.querySelectorAll('.searchable-table');

        tables.forEach(table => {
            let rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                let showRow = false;
                if (filterField === 'all') {
                    if (row.innerText.toLowerCase().includes(filterValue)) showRow = true;
                } else {
                    let dataValue = row.getAttribute('data-' + filterField);
                    if (dataValue && dataValue.includes(filterValue)) showRow = true;
                }
                row.style.display = showRow ? '' : 'none';
            });
        });
    }
    document.getElementById("searchInput").addEventListener("keyup", filterProjects);
    document.getElementById("filterField").addEventListener("change", filterProjects);

    document.getElementById('searchRelatorInput').addEventListener('keyup', function() {
        let filter = this.value.toLowerCase();
        let items = document.querySelectorAll('.relator-item');
        items.forEach(item => {
            let nome = item.querySelector('.relator-name').innerText.toLowerCase();
            let email = item.querySelector('.relator-email').innerText.toLowerCase();
            item.style.display = (nome.includes(filter) || email.includes(filter)) ? '' : 'none';
        });
    });
</script>
{% endblock %}